<?php

// +----------------------------------------------------------------------
// | FileName:   KdFindController.class.php
// +----------------------------------------------------------------------
// | Dscription:
// +----------------------------------------------------------------------
// | Date:  2017/8/23 16:08
// +----------------------------------------------------------------------
// | Author: showkw <showkw@163.com>
// +----------------------------------------------------------------------
namespace Home\Controller;

use Common\Controller\KdApiController as KdApi;
use Home\Event\OrderEvent;

class KdController extends HomeController
{
    protected function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
        $user_id = session( 'userId' );
        $userType = session( 'userType' );
        if ( $userType == 1 ) {
            $key = 'ssid_' . $user_id;
            if ( S( $key ) ) {
                $ssid = S( $key );
                if ( $this->ssid !== $ssid ) {
                    session( null );
                    S( $key, null );
                    redirect( U( 'Home/Account/login', [ 'isRelogin' => 1 ] ) );
                }
            }
        }
    }


    /*
     *
     * 查询快递信息
     * @param  OrderCode        订单编号         可选
     * @param  ShipperCode      快递公司编号      必选
     * @param  LogisticCode     快递物流单号      必选
     * @param  type             物流类型   默认0为订单物流信息   1为发票物流信息
     */
    public function info( $shipperCode = '', $logisticCode = '', $orderCode = '', $type = 0 ,$isAjax=true)
    {

        $shipperCode = I( 'post.shipperCode' ) ? I( 'post.shipperCode' ) : $shipperCode;
        $logisticCode = I( 'post.logisticCode' ) ? I( 'post.logisticCode' ) : $logisticCode;
        $orderCode = I( 'post.orderCode' ) ? I( 'post.orderCode' ) : $orderCode;
        $type = I( 'type' ) ? I( 'type' ) : $type;
        if (empty( $logisticCode ) ) {
            if ( IS_AJAX ) {
                $this->ajaxReturnStatus( 1001, '缺少快递/物流单号参数!' );
            } else {
                return [];
            }
        }
        if( empty( $shipperCode ) ){
            $kd = KdApi::getInit();
            $kdArr= $kd::getKdCodeByKdNum( $logisticCode, false );
            if( $kdArr ){
                $kdCode = $kdArr['kdCode'];
                if( !empty( $orderCode ) ){
                    M('order_sync_hy')->where([ 'order_no' => $orderCode , 'hy_num'=>$logisticCode])
                        ->save([
                            'kd_code'=>$kdCode,
                            'is_kd'=>1,
                        ]);
                }
            }
            $shipperCode = $kdCode;
        }
        ////先查询缓存是否有数据  如果有数据则从缓存读取
        $key = 'KD::' . $shipperCode . $logisticCode;
        $data = S( $key );
        if ( !$data || empty( $data['traces'] )  ) {
            //如果缓存中无数据 则去API接口查询
            $dataApi = $this->getInfoByApi( $shipperCode, $logisticCode, $orderCode, $type );

            if ( $dataApi['traces'] ) {
                //查到数据写入缓存
                S( $key, null );
                S( $key, $dataApi, 1800 );
                //从缓存读取
                $data = S( $key );
            }
        }
        if ($isAjax && IS_AJAX   ) {
            if ( empty( $data ) ) {
                $this->ajaxReturnStatus( 1001, '' );
            }else{
                $this->ajaxReturn($data);
            }
        }

        return $data;

    }


    /*
     * 从数据库读取
     */
    protected function getInfoBySql( $shipperCode, $logisticCode, $orderCode = '', $type = 0 )
    {
        $delivery = M( 'order_delivery' );
        if ( $orderCode ) {
            $where[ 'order_sn' ] = $orderCode;
            $where[ 'type' ] = $type;
        } else {
            $where = [
                'delivery_code' => $shipperCode,
                'delivery_num'  => $logisticCode,
                'type'          => $type,
            ];
        }
        $detail = $delivery->where( $where )->find();

        return json_decode( $detail[ 'delivery_detail' ], true );
    }

    /*
     * 从API接口读取
     *
     * State  0-无轨迹   1-已揽收   2-在途中   3-签收    4-问题件
     *
     */
    protected function getInfoByApi( $shipperCode, $logisticCode, $orderCode = '', $type = 0 )
    {
        $kd = KdApi::getInit();
        $json = $kd::getOrderTracesByJson( $shipperCode, $logisticCode, $orderCode );
        $data = json_decode( $json, true );

//		return $data;
//		if( $data['Success'] ){
//			rsort($data['Traces']); //将数组逆向排序
//			//如果物流已签收 那么写入数据库
//			if( $data['State'] == 3 ){
//				$insert['order_sn'] = $orderCode;
//				$insert['delivery_code'] = $shipperCode;
//				$insert['delivery_num'] = $logisticCode;
//				$insert['delivery_detail'] = json_encode(['state'=>$data['State'],'traces'=>$data['Traces']]);
//				$insert['state'] = 3;
//				$insert['type'] = $type;
//				D('order_delivery')->add($insert);
//				//写入缓存

//			}
//		}
        empty($data['Traces']) && $data[ 'Traces' ][ 0 ] = [
            'AcceptTime'    => date( 'Y-m-d H:i:s' ),
            'AcceptStation' => '暂无物流轨迹!请稍后查询!',
        ];
        $data['Traces'] = array_reverse($data['Traces']);
        return [ 'state' => $data[ 'State' ], 'traces' => $data[ 'Traces' ] ];
    }

    /**
     * 单号识别
     * @param string $logisticCode
     * @return false|array
     */
    public function getKdCodeByApi( $logisticCode )
    {
        $kd = KdApi::getInit();
        $json = $kd::getKdCodeByKdNum( $logisticCode);
        $data = json_decode( $json, true );
        if( $data['Success'] ){
            return ['logisticCode'=>$data['LogisticCode'],'shippers'=>$data['Shippers']];
        }else{
            return false;
        }
    }

    public function getKdCode( $kdNum='', $kdName='')
    {

    }
}