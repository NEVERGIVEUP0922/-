<?php

// +----------------------------------------------------------------------
// | FileName:   ProductController.class.php
// +----------------------------------------------------------------------
// | Dscription:   产品控制器类
// +----------------------------------------------------------------------
// | Date:  2017/8/7 12:45
// +----------------------------------------------------------------------
// | Author: showkw <showkw@163.com>
// +----------------------------------------------------------------------

namespace Home\Controller;

use Admin\Controller\MsgController;
use Home\Controller\HomeController;
use Org\ThinkSDK\sinaClient;
use Org\ThinkSDK\ThinkOauth;
use Home\Controller\DefaultController;


class UserProductController extends HomeController
{
	public $category_list;
	public $brand_list;
	
	public $upload_root = '';
	
	protected function _initialize()
	{
        parent::_initialize(); // TODO: Change the autogenerated stub
        //		!is_login() && redirect(U('Home/Account/login'));
        $this->_model = D( 'User' );
        //dump(session());
        !is_login() && redirect( U( 'Home/Account/login' ) );
        $user_id = session( 'userId' );

        $userType = session('userType');
        if( $userType == 1 ){
            $key = 'ssid_'.$user_id;
            if(S($key)){
                $ssid = S($key);
                if( $this->ssid !== $ssid ){
                    session(null);
                    S($key,null);
                    redirect(U('Home/Account/login', ['isRelogin'=>1]));
                }
            }
        }

        $order_m=new \Home\Controller\OrderController();//企业子账号信息
        $companySons=$order_m->companySons();
        if($companySons['error']==0){
            $users=$companySons['data'];
            $user_id=['in',$users];
        }
	}

    /**
     * @desc 样品申请
     *
     */
	public function userProductSample(){
	    $request=I('post.');

	    $session=session();
	    $request['user_id']=$session['userId'];

	    $where=['user_id'=>(int)$request['user_id'],'status'=>['neq',40]];

	    if($request['action']){
            if($request['type']=='boxSample'){//box表格读取数据
                if(isset($request['list'])||!$request['list']) die(json_encode(['error'=>-1,'msg'=>'表格信息错误']));
                $list=D('Home/File','Design')->boxProductSample($request['list']);
                if($list['error']<0) die(json_encode($list));
                $request['items']=$list['data']['items'];
            }
        }

	    $result=D('Home/UserProduct','Design')->userProductSample($request,$where);

	    if($request['action']) die(json_encode($result));

	    $this->assign($result['data']);
	    $this->display();
    }




}
