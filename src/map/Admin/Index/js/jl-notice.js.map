{"version":3,"sources":["Admin/Index/js/jl-notice.js"],"names":["layui","define","exports","new_res","layer","laypage","error_time","mark_time","Date","$num","$","isFirstPage","getting","url","dataType","timeout","success","res","pullMsg","new","getNewData","open","icon","btn","title","shade","anim","offset","content","layero","index","on","close","error","getInfo","setTimeout","after_time","ajax","renew","get","data","count","text","show","hide","isClose","isArray","list","length","type","area","time","btnAlign","getTrList","renderPage","$table","id","this","$tr","addClass","parent","$tBody","post","msg_id","splice","fadeOut","remove","children","getData","tr_html","find","html","new_num","parseInt","msg","load","s","msg_content","split","alert","join","btn2","trList","console","log","each","value","name_arr","msg_title","send","name","recive","i","val","push","render","elem","limit","curr","page","layout","jump","obj","first","query","callback","isFunction"],"mappings":"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","file":"../../../../../temporaryJs/Admin/Index/js/jl-notice.js","sourcesContent":["'use strict';\n\nlayui.define(['layer', 'laypage'], function (exports) {\n    var layer = layui.layer;\n    var laypage = layui.laypage;\n    //长轮循\n    var new_res;\n    var error_time = 0;\n    var mark_time = +new Date();\n    var $num = $('.jl-notice-num');\n    var isFirstPage = true; //顽疾\n    var getting = {\n        url: '/Admin/Msg/pullMsg',\n        dataType: 'json',\n        timeout: 24000,\n        // data: {time: 4},\n        success: function success(res) {\n            //console.log(res);\n            error_time = 0;\n            pullMsg();\n            //最新数据\n            if (res && res.new) {\n                getNewData();\n                layer.open({\n                    icon: 9,\n                    btn: false,\n                    title: '消息提醒',\n                    shade: 0,\n                    anim: 6,\n                    offset: '0px',\n                    content: '<a class=\"jl-msg-notice\" style=\"cursor:pointer\">你有' + res.new + '新消息</a>',\n                    success: function success(layero, index) {\n                        //console.log(layero, index);\n                        $(\".jl-msg-notice\").on(\"click\", function () {\n                            layer.close(index);\n                            res.error = 0;\n                            getInfo(res, true);\n                        });\n                    }\n                });\n            }\n        },\n        error: function error() {\n            //递增错误间隔，最大10秒\n            setTimeout(function () {\n                pullMsg();\n            }, 2000 * error_time);\n            if (error_time < 5) {\n                error_time++;\n            }\n        }\n    };\n    var pullMsg = function pullMsg() {\n        //请求最小间隔2秒\n        var mini_time = 2000;\n        var now_time = new Date();\n        var after_time = now_time - mark_time;\n        if (after_time < mini_time) {\n            setTimeout(function () {\n                mark_time = +new Date();\n                $.ajax(getting);\n            }, mini_time - after_time);\n        } else {\n            mark_time = +new Date();\n            $.ajax(getting);\n        }\n    };\n    function getNewData(renew) {\n        isFirstPage = true;\n        $.get('/Admin/Msg/getAllUnReadMsgList', function (res) {\n            new_res = res;\n            if (res.error === 0) {\n                if (res.data.count !== 0) {\n                    $num.text(res.data.count).show();\n                    if (renew) getInfo();\n                } else {\n                    $num.hide();\n                }\n            } else {\n                $num.hide();\n            }\n        });\n    };\n    getNewData();\n    pullMsg();\n    //查看按钮\n    $(\".showNotice\").on(\"click\", function () {\n        getNewData(true);\n    });\n    function getInfo(res, isClose) {\n        res ? new_res = res : '';\n        if (new_res && new_res.error === 0 && new_res.data && $.isArray(new_res.data.list) && new_res.data.list.length !== 0) {\n            layer.open({\n                type: 1,\n                title: \"系统消息\",\n                area: '600px',\n                time: isClose ? 5000 : 0,\n                btn: ['关闭'],\n                btnAlign: 'c',\n                content: '<div class=\"jl-msg-container\">' + '<table class=\"jl-msg-table layui-table\" lay-size=\"sm\">' + '<colgroup><col><col><col><col width=\"60\"></colgroup>' + '<thead><tr><th>消息标题</th><th>发送者</th><th>接收者</th><th>操作</th></tr></thead>' + '<tbody>' + getTrList(new_res) + '</tbody>' + '</table>' + '<div class=\"jl-msg-page\"></div>' + '</div>',\n                success: function success(layero, index) {\n                    renderPage(new_res);\n                    var $table = $('.jl-msg-table');\n                    $table.on('click', '.jl-read-btn', function () {\n                        var id = $(this).data('id');\n                        var $tr = $(this).addClass('layui-btn-primary').text('已读').parent().parent();\n                        var $tBody = $tr.parent();\n                        $.post('/Admin/Msg/setMsgReaded', { msg_id: id }, function (res) {\n                            if (res.error === 0) {\n                                var index = $tr.index();\n                                if (isFirstPage && new_res && new_res.data && $.isArray(new_res.data.list)) {\n                                    new_res.data.list.splice(index, 1);\n                                }\n                                $tr.fadeOut(function () {\n                                    $(this).remove();\n                                    if ($tBody.children().length === 0) {\n                                        getData(false, function (res) {\n                                            var tr_html = getTrList(res);\n                                            $('.jl-msg-container').find('tbody').html(tr_html);\n                                            renderPage(res);\n                                        });\n                                    }\n                                });\n                                var new_num = parseInt($num.text()) - 1;\n                                if (new_num !== 0) {\n                                    $num.text(new_num);\n                                } else {\n                                    $num.text(new_num).hide();\n                                }\n                            } else {\n                                layer.msg(res.msg);\n                            }\n                        });\n                    });\n                    $table.on('click', '.jl-msg-title', function () {\n                        var index = layer.load();\n                        var id = $(this).data('id');\n                        $.get('/Admin/Msg/getMsgContent', { msg_id: id }, function (res) {\n                            layer.close(index);\n                            if (res.error === 0) {\n                                var s = res.data.msg_content.split('{}');\n                                layer.alert(s.join('<br>'));\n                            } else {\n                                layer.msg(res.msg);\n                            }\n                        });\n                    });\n                },\n                btn2: function btn2() {}\n            });\n        } else {\n            layer.msg('暂无消息');\n        }\n    };\n    var getTrList = function getTrList(res) {\n        var trList = '';\n        console.log(res);\n        if (res.data && res.data.list && $.isArray(res.data.list) && res.data.list.length !== 0) {\n            $.each(res.data.list, function (index, value) {\n                trList += '<tr><td><a data-id=\"' + value.msg_id + '\" class=\"jl-msg-title\" href=\"javascript:\">' + value.msg_title + '</a></td><td><a data-id=\"\\' + value.msg_id + \\'\" class=\"jl-msg-title\" href=\"javascript:\">' + value.send.name + '</a></td>' + '<td>' + function () {\n                    var name_arr = [];\n                    $.each(value.recive, function (i, val) {\n                        name_arr.push(val.name);\n                    });\n                    return name_arr.join(',');\n                }() + '</td><td>' + '<button data-id=\"' + value.msg_id + '\" class=\"jl-read-btn layui-btn layui-btn-sm\">标记已读</button>' + '</td></tr>';\n            });\n        } else {\n            trList = '<tr><td style=\"text-align: center\" colspan=\"3\">没有消息</td></tr>';\n        }\n        return trList;\n    };\n    var renderPage = function renderPage(res) {\n        laypage.render({\n            elem: $('.jl-msg-page').get(0),\n            limit: 10,\n            count: res && res.data && res.data.count,\n            curr: res && res.data && res.data.page,\n            layout: ['prev', 'page', 'next'],\n            jump: function jump(obj, first) {\n                if (!first) {\n                    getData({ page: obj.curr }, function (res) {\n                        var tr_html = getTrList(res);\n                        $('.jl-msg-container').find('tbody').html(tr_html);\n                        renderPage(res);\n                    });\n                }\n            }\n        });\n    };\n    var getData = function getData(query, callback) {\n        query = query ? query : { page: 1 };\n        query['page'] = query.page ? query.page : 1;\n        isFirstPage = query['page'] === 1;\n        $.get('/Admin/Msg/getAllUnReadMsgList', query, function (res) {\n            if (res && res.data && $.isArray(res.data.list) && res.data.list.length !== 0) {\n                if (callback && $.isFunction(callback)) callback(res);\n            } else if (query.page !== 1) {\n                getData(false, callback);\n            } else {\n                if (callback && $.isFunction(callback)) callback(res);\n                new_res = false;\n            }\n        });\n    };\n    exports(\"jlNotice\", {});\n});"]}